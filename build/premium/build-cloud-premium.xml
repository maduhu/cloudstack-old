<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright 2008 Cloud, Inc. All Rights Reserved -->

<project name="Cloud Stack Premium" default="help" basedir=".">
  <description>
		Cloud Stack ant build file
    </description>

  <!--
 	Always use this variable to refer to the base directory because this
	variable is changeable
    -->
  <dirname property="base.dir" file="${ant.file.Cloud Stack Premium}/../.." />
  <property name="build.dir" location="${base.dir}/build" />
 
  <import file="${build.dir}/build-cloud.xml" optional="false"/> 

  <!-- directories for premium code compilation -->
  <property name="premium.dir" location="${base.dir}/premium" />
  <property name="premium.test.dir" location="${premium.dir}/test/" />
  
  <property name="core-premium.dir" location="${base.dir}/core-premium" />
  <property name="core-premium.test.dir" location="${core-premium.dir}/test/" />
  
  <property name="usage.dir" location="${base.dir}/usage" />
  <property name="usage.dist.dir" location="${dist.dir}/usage" />

  <property name="console-proxy-premium.dir" location="${base.dir}/console-proxy-premium" />

  <!-- directories for branding -->
  <property name="branding.dir" location="${build.dir}/deploy/branding/${branding.name}" />

  <property name="premium.jar" value="cloud-server-extras.jar" />
  <property name="usage.jar" value="cloud-usage.jar" />
  <property name="console-proxy-premium.jar" value="cloud-console-proxy-premium.jar" />
  <property name="core-premium.jar" value="cloud-core-extras.jar"/>
  
  <!-- ===================== core-extras.Jar ===================== -->
  <path id="core-premium.classpath">
    <path refid="thirdparty.classpath" />
    <path refid="dist.classpath" />
  </path>
  <target name="compile-core-premium" depends="-init, compile-utils, compile-core, compile-server" description="Compile the premium business logic.">
<!-- compile-server is now added because core-premium imports a class com.cloud.configuration.Config that is only in server.jar.  These are the kinds of
     bugs that are only discovered with a parallel compilation mode.  You are welcome. -->
    <compile-java jar.name="${core-premium.jar}" top.dir="${core-premium.dir}" classpath="core-premium.classpath" />
  </target>

  <!-- ===================== Premium.Jar ===================== -->
  <path id="premium.classpath">
    <path refid="thirdparty.classpath" />
    <path refid="dist.classpath" />
  </path>
  <target name="compile-premium" depends="-init, compile-utils, compile-core-premium, compile-server, compile-console-proxy" description="Compile the premium business logic.">
    <compile-java jar.name="${premium.jar}" top.dir="${premium.dir}" classpath="premium.classpath" />
  </target>

  <!-- ===================== Usage.Jar ===================== -->
  <path id="usage.classpath">
    <path refid="thirdparty.classpath" />
    <path refid="dist.classpath" />
  </path>
  <target name="compile-usage" depends="-init, compile-utils, compile-core, compile-server, compile-premium" description="Compile the usage server">
    <compile-java jar.name="${usage.jar}" top.dir="${usage.dir}" classpath="usage.classpath" />
  </target>

  <target name="build-usage" depends="compile-premium, compile-usage">
    <mkdir dir="${usage.dist.dir}/bin" />
    <mkdir dir="${usage.dist.dir}/conf" />

    <copy todir="${usage.dist.dir}/bin">
      <fileset dir="${usage.dir}/scripts">
        <include name="usageserver.sh" />
      </fileset>
    </copy>
    <copy overwrite="true" todir="${usage.dist.dir}/lib">
      <fileset dir="${jar.dir}">
        <include name="${usage.jar}" />
      </fileset>
    </copy>
  </target>

  <!-- ===================== Console-Proxy-Premium.Jar ===================== -->
  <path id="console-proxy-premium.classpath">
    <path refid="thirdparty.classpath" />
    <path refid="dist.classpath" />
  </path>
  <target name="compile-console-proxy-premium" depends="compile-console-proxy" description="Compile the console proxy security extenstion.">
    <compile-java jar.name="${console-proxy-premium.jar}" top.dir="${console-proxy-premium.dir}" classpath="console-proxy-premium.classpath">
      <include-files>
        <fileset dir="${console-proxy-premium.dir}/certs">
          <include name="*.keystore" />
          <include name="*.crt" />
          <include name="*.key" />
        </fileset>
      </include-files>
    </compile-java>
  </target>

  <target name="build-console-proxy-premium" depends="compile-console-proxy-premium, copy-console-proxy">
    <copy todir="${console-proxy.dist.dir}">
      <fileset dir="${jar.dir}">
        <include name="cloud-console-proxy-premium.jar" />
      </fileset>
    </copy>
    <mkdir dir="${console-proxy.dist.dir}/certs" />
    <copy todir="${console-proxy.dist.dir}/certs">
      <fileset dir="${console-proxy-premium.dir}/certs">
          <include name="*.keystore" />
          <include name="*.crt" />
          <include name="*.key" />
      </fileset>
    </copy>
  </target>


  <target name="build-xenserver-domr-patch" depends="-init">
    <tar destfile="${dist.dir}/patch.tar">
      <tarfileset dir="${base.dir}/patches/xenserver" filemode="755">
        <include name="**/*"/>
        <exclude name="**/.classpath" />
        <exclude name="**/.project" />
      </tarfileset>
      <tarfileset dir="${base.dir}/patches/shared" filemode="755">
        <include name="**/*"/>
        <exclude name="**/.classpath" />
        <exclude name="**/.project" />
      </tarfileset>     
    </tar>
    <gzip destfile="${dist.dir}/patch.tgz" src="${dist.dir}/patch.tar"/>
    <delete file="${dist.dir}/patch.tar"/>
  </target>

  
  <target name="build-premium" depends="build-opensource, compile-premium, build-usage, build-console-proxy-premium, build-xenserver-domr-patch">
    <copy overwrite="true" todir="${server.dist.dir}/conf">
      <fileset dir="${base.dir}/premium/tomcatconf">
        <include name="*.in" />
      </fileset>
      <globmapper from="*.in" to="*" />
      <filterchain>
        <filterreader classname="org.apache.tools.ant.filters.ReplaceTokens">
          <param type="propertiesfile" value="${override.file}" />
        </filterreader>
      </filterchain>
    </copy>
  </target>
  
</project>


